---
title: "Final Report"
date: last-modified
date-format: "MMMM D, YYYY"
author: 
    - name: Maya Doitch
      affil-id: 1
    - name: Ruben Jimenez
      affil-id: 1
    - name: Alea Seifert
      affil-id: 1
affiliations:
    - id: 1
      name: Department of Statistics, Cal Poly - SLO
abstract: "hqwvdfiqef"
format: 
  pdf:
    number-sections: true
    template-partials: ssssss
      - title.tex
    include-in-header:
      text: |
        \usepackage[noblocks]{authblk}
        \renewcommand*{\Authsep}{, }
        \renewcommand*{\Authand}{, }
        \renewcommand*{\Authands}{, }
        \renewcommand\Affilfont{\small}
execute: 
  warning: false
  message: false
  echo: false
bibliography: references.bib
---


```{r loading in data}
#| label: load in data & libraries
set.seed(7000)

library(readr)
library(tidyverse)
library(lme4)
library(performance)
library(ggplot2)
library(ICC)
library(GGally)
library(effects)

#df_baseball <- read_csv("https://www.dropbox.com/scl/fi/2bcvc8eabdinum2e3r9oj/statcast_pitch_swing_data_20240402_20240630.csv?rlkey=bl9kxe5o9yv017cmjssbgya3s&st=pnrx2dej&dl=1")

load("df_baseball_clean.RData")
```

## Introduction {#intro}

A few paragraphs that contain background information, motivation for your\
research, and a statement of your research goals. Be sure to incorporate any supporting\
references into the text. The purpose of the background is to place your work in the greater context of the literature in the area you are investigating. Then you should explicitly identify a hypothesis that you will investigate with your analysis. Don’t assume the reader remembers any of your earlier project reports.

We chose this project because baseball is not only fun to watch, but has various opportunities to explore multilevel data. While being from major baseball We decided to analyze how the distance of a hit can be impacted by other factors in a game. We think that the relative hit location of the ball in the batting box and how the ball is thrown (angle and speed) will impact the hit distance. Since there is so much variability between different players' hits, we will include batter in the model. We have also included pitch type as we might need to control for this variable when analyzing hit distance. We want to see what precedes a a far distance hit.

## Data and Methods![](STAT%20414%20Presentation.png)

### Data Description

-   Briefly describe your data, where your data came from (source), definitions of important variables, and how the data were collected. You should include a variables table and/or diagram representing your study.

    \*The data comes from Baseball Savant which records various aspects of plate appearances in MLB games. The data recorded comes from 4/2/2024 to 6/30/2024. This documentation was available at [**Baseball Savant**](https://baseballsavant.mlb.com/csv-docs) and can be downloaded at [**Share Point**](https://yaleedu-my.sharepoint.com/personal/brian_macdonald_yale_edu/_layouts/15/onedrive.aspx?id=%2Fpersonal%2Fbrian%5Fmacdonald%5Fyale%5Fedu%2FDocuments%2Fservice%2FCSAS%2F2025%2D04%2D11%20%2D%20CSAS%20at%20Yale%2Fdata%2Echallenge%2Fdata&ga=1)**.** The data was collected from a Statcase system which includes various cameras that are dedicated to tracking pitches, hits, and players. In the dataset, there are over 90 variables about all aspects of an mlb game, but we will only be looking at a few variables of interest.

-   Indicate any modifications made to the data, recoding, or decisions about missing data

```{r}
#| label: Grand Mean Centering
df_baseball_clean <- df_baseball |>
  mutate(dist_from_cen = sqrt((plate_x^2) + (plate_z^2)),
         pitch_type = factor(pitch_type),
         game_type = factor(game_type),
         batter = factor(batter),
         stand = factor(stand),
         type = factor(type),
         zone = factor(zone),
         p_throws = factor(p_throws)) |>
  select(type, hit_distance_sc, pitch_type, dist_from_cen, launch_angle, launch_speed, game_type, batter, stand, plate_x, plate_z, pfx_x, pfx_z, release_speed, release_pos_x, release_pos_y, release_pos_z, zone, release_spin_rate, p_throws, balls, strikes, effective_speed, release_extension) |>
  filter(type == "X") |>
  drop_na() |>
  mutate(dist_from_cen_gmc = dist_from_cen - mean(dist_from_cen),
         hit_distance_gmc = hit_distance_sc - mean(hit_distance_sc),
         launch_angle_gmc = launch_angle - mean(launch_angle),
         launch_speed_gmc = launch_speed - mean(launch_speed),
         release_speed_gmc = release_speed - mean(release_speed),
         release_pos_x_gmc = release_pos_x - mean(release_pos_x),
         release_pos_y_gmc = release_pos_y - mean(release_pos_y),
         release_pos_z_gmc = release_pos_z - mean(release_pos_z),
         release_spin_gmc = release_spin_rate - mean(release_spin_rate),
         plate_x_gmc = plate_x - mean(plate_x),
         plate_z_gmc = plate_z - mean(plate_z),
         pfx_x_gmc = pfx_x - mean(pfx_x),
         pfx_z_gmc = pfx_z - mean(pfx_z),
         effective_speed_gmc = effective_speed - mean(effective_speed),
         release_extension_gmc = release_extension - mean(release_extension))
```


```{r}
#| label: Taking a Random Sample 
set.seed(7000)
baseball_sample <- df_baseball_clean[sample(nrow(df_baseball_clean), 1000), ] |> arrange(desc(batter))
head(baseball_sample)
```

```{r}
#| label: PitchType Variable Coding 
final_data <- baseball_sample |>
  mutate(is_fastball = as.integer(pitch_type %in% c("SI", "FF", "CU", "FA"))) |>
  mutate(is_fastball = factor(is_fastball))
```

 -GMC
 -taking a random sample
 -fastball coding

### Statistical Analysis

-   Briefly describe the methods you used (e.g., multilevel regression) in your analysis

-   Do not report results in this section!

## Results

-   Summarize the results of your exploratory data analysis (e.g., include a matrix plot?). Which Level 1 and Level 2 variables appeared to be most promising before you built your final model

```{r}
#| label: Matrix Plot for quantitative variables
num_vars <- final_data |>
  mutate(log_la = log(launch_angle_gmc),
         sqrt_ls = sqrt(launch_angle_gmc),
         launch_angle_sqd = launch_angle_gmc^2) |>
  select(hit_distance_sc, launch_angle_gmc, launch_speed_gmc, launch_angle_sqd)

ggpairs(num_vars, title = "Matrix Plot Between Numeric Predictors, Response", columnLabels = c("Hit Distance", "Launch Angle", "Launch Speed", "Launch Angle^2"))
```


```{r}
#| label: Categorical Analysis
# Maya ADD slide plots 
```


-   Summarize the results of your initial anova exploring the significance of the Level 2 grouping variable.

```{r}
model0 <- lm(hit_distance_sc ~ batter, data= final_data)
anova(model0)
```

-   Summarize, including (with a useful picture), your null model and what you learn, including interpreting the ICC value in context.

```{r}
#| label: Graph of variability between random 10 batters (number of hits)
#| fig-cap: "A random sample of 10 Batters in the dataset"
#| fig-align: center
#| fig-pos: "H"
set.seed(7000)

top_batters <- final_data |>
  distinct(batter) |>  
  slice_sample(n = 10)  

filtered_data <- final_data |>
  filter(batter %in% top_batters$batter)  

ggplot(filtered_data, aes(x = batter, y = hit_distance_sc)) +
  geom_boxplot(fill = "skyblue", color = "black") +
  labs(title = "Distance Hit by Batter",
       x = "Batter ID",
       y = "Distance (ft)") +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
nullmodel <- lmer(hit_distance_sc ~ 1 + (1 | batter), data=final_data)
summary(nullmodel)

ICC::ICCbare(y=final_data$hit_distance_sc, x = final_data$batter)

logLik(nullmodel)
performance(nullmodel)
```

$ \tau_0^2: $ The batter to batter variance in average hit distance is 292.9.

$ \sigma^2: $ The variance in average hit distance for each batter is 17985.5.

$ \beta_0: $ The average hit distance across all batters is 164.116.

$$ ICC: \frac{292.9}{292.9 + 17985.5} = 0.01602438$$ The correlation between two hits by the same batter is .016. 1.6% of the variation is explained by within batter variation in hit distance rather than between batters. This is not substantial. The log likelihood of the null model is -384430.9. The deviance is 134.11 feet. The AIC is 7.689*10^5.  

**ALL NEEDS TO BE CHANGED but should be interpretations^^^^**

-   Brief discussion of how you arrived at your final model. Interpret all of the estimated parameters in your final model in context. Include at least one confidence interval or interval of random slopes and interpret in context. (But there shouldn’t really be much “commentary” in this section.) How much of the unexplained Level 1 and/or Level 2 variation in the null model is explained by your final model?

-   Integrate the most relevant figures to help interpret the results with your discussion. This includes graphs illustrating fixed effects, random effects, and interactions.

-   These tables and figures should be well-labeled, numbered (e.g., Figure 1), and\
    have a good, descriptive caption.

-   Especially effective graphs compare your data to the model and discuss how the\
    model does and does not capture important features of the data. At least\
    consider showing the “effects plots” in addition to the raw data graphs.

-   Each report should have a minimum of two plots (could be several more, just\
    keep them well-sized and well-integrated into the discussion).

-   Diagnostic analysis: Discussion and inclusion of residual plots (with commentary) for your final model


#### Fixed Effects

```{r}
#| label: Interaction effect graph
final_data |>
  ggplot(aes(x = stand, y=hit_distance_sc)) +
  geom_boxplot() +
  facet_grid(~is_fastball) +
  theme_bw() + 
  labs(title ="Interaction Between Dominant Hand and Fastball", x = "Dominant Hand", y = "Hit Distance")
```

```{r}

```


#### Random Effects

```{r}
#| label: Random Slopes graph
model6 <- lmer(hit_distance_sc ~ is_fastball + launch_angle_gmc + launch_speed_gmc + stand + (1 + launch_angle_gmc | batter), data=final_data, REML = TRUE)
summary(model6)

ggplot(final_data, aes(x = launch_angle_gmc, y = hit_distance_sc)) +
  geom_smooth(aes(group = batter),
          method = "lm",
          se     = FALSE,      # do NOT want the SE bands
          linewidth   = 0.3) +   theme_bw()

fits1 = fitted.values(model6, level =1)
```

-including random slopes interval


#### Final Model

```{r}
#| Final Model
model11 <- lmer(hit_distance_sc ~ launch_angle_gmc + I(launch_angle_gmc^2)*launch_speed_gmc + stand + is_fastball  + (1 + launch_angle_gmc + I(launch_angle_gmc^2) | batter), data=final_data, REML = TRUE)
anova(nullmodel, model11)
```


**Interpretation of all the variables**

**How much of the unexplained Level 1 and/or Level 2 variation in the null model is explained by your final model?**

```{r}
#| label: residual plots
```


## Discussion {#discussion}

Describe how the results help answer your research questions and what was most\
interesting from your analysis. In fact, the first paragraph of the Discussion is very\
important – in professional journals, it is often the first and sometimes the only\
paragraph that is read in a paper. After the first sentence highlights primary results, the remainder of the first paragraph might compare your results to others in the literature or include interesting secondary results.

-   Discuss possible implications of the results in the context of the research question.

****

-   Identify any limitations of your study. Discuss the potential impact of such limitations onthe conclusions. (e.g., potential confounding variables, generalizability - Don’t give generic statements of possible causation and generalizability, but thoughtfully discuss relevant issues – confounding variables, representativeness of the sample, etc.)

-   Identify strengths and weaknesses of your analysis.

-   Make suggestions for future research. Identify important next steps that a researcher could take to build on your work.


****

{{< pagebreak >}}

## Appendix {.unnumbered}

Make sure you submit your raw data and make sure I know definitions of important
variables and the source of the data.

- Your reproducible model building details.

- Tables and figures that are informative but were not referenced specifically in the main report. Include a short annotation – one or two sentences on what they show.

- Description of statistical modeling steps that were not included in the main body of your report. Possible entries here include:
  - Evaluation of assumptions.
  - Outlier analysis and how you decided to deal with any outliers along with rationale
for your decision.
  - Describe hypotheses testing you performed during model building and how you
decided on the explanatory variables you ultimately included in your final model.
  - Assessment of the final model.
  - If applicable: How you went from the model output in R to interpretations in your report(e.g. exponentiate coefficients, then take inverse)
  - Anticipate questions someone might have after reading your report, and make sure those
questions can be answered with information in the appendix.
  -A citation for any reference article(s) you included in your proposal. Also include a link, if appropriate

## 
